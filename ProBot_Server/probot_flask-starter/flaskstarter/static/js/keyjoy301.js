var up=0;var down=0;var left=0;var right=0;var keys=[];var keysMsg=[0,0,0,0];var INC=0.08;var MAX=0.75;var this_js_script=$("script[src*=keyjoy]");var probot_id=this_js_script.attr("probot_id");function keyboardHandler(d,b){function c(f){f=f+INC;if(f>=MAX){f=MAX}return f}document.onkeydown=a;function a(f){f=f||window.event;keys[f.keyCode]=true;if(keys[38]&&keys[37]){up=c(up);left=c(left)}if(keys[38]&&keys[39]){up=c(up);right=c(right)}if(keys[40]&&keys[37]){down=c(down);left=c(left)}if(keys[40]&&keys[39]){down=c(down);right=c(right)}if(f.keyCode==38){up=c(up)}if(f.keyCode==40){down=c(down)}if(f.keyCode==37){left=c(left)}if(f.keyCode==39){right=c(right)}if(up!=0||down!=0||left!=0||right!=0){window.time=new Date().getTime()}keysMsg=[up.toFixed(3),down.toFixed(3),left.toFixed(3),right.toFixed(3)];d.publish(b,[keysMsg])}document.onkeyup=e;function e(f){f=f||window.event;keys[f.keyCode]=false;if(!keys[38]){up=0}if(!keys[40]){down=0}if(!keys[37]){left=0}if(!keys[39]){right=0}keysMsg=[up.toFixed(3),down.toFixed(3),left.toFixed(3),right.toFixed(3)];d.publish(b,[keysMsg])}document.getElementById("joystick").disabled=true}function joystickHandler(f,c){var a=false;var d;function e(){return"getGamepads" in navigator}function b(){var j=navigator.getGamepads()[0];var h="";h+="id: "+j.id+"<br/>";for(var g=0;g<j.buttons.length;g++){h+="Button "+(g+1)+": ";if(j.buttons[g].pressed){h+=" pressed"}h+="<br/>"}for(var g=0;g<j.axes.length;g+=2){h+="Stick "+(Math.ceil(g/2)+1)+": "+j.axes[g]+","+j.axes[g+1]+"<br/>";if(j.axes[1]==0){up=0;down=0}if(j.axes[1]<0){up=j.axes[1]*-MAX;down=0}if(j.axes[1]>0){down=j.axes[1]*MAX;up=0}if(j.axes[2]==0){left=0;right=0}if(j.axes[2]<0){left=j.axes[2]*-MAX;right=0}if(j.axes[2]>0){right=j.axes[2]*MAX;left=0}if(up!=0||down!=0||left!=0||right!=0){window.time=new Date().getTime()}keysMsg=[up.toFixed(3),down.toFixed(3),left.toFixed(3),right.toFixed(3)];f.publish(c,[keysMsg])}$("#gamepadDisplay").html(h)}$(document).ready(function(){if(e()){$("gamepadPrompt").text("To use your gamepad, connect it and press any key!");$(window).on("gamepadconnected",function(){a=true;$("gamepadPrompt").text("Gamepad connected!");console.log("Gamepad connected!");d=window.setInterval(b,200)});$(window).on("gamepaddisconnected",function(){console.log("Gamepad disconnected!");$("gamepadPrompt").text("Gamepad disconnected!");window.clearInterval(d)});var g=window.setInterval(function(){if(navigator.getGamepads()[0]){if(!a){$(window).trigger("gamepadconnected")}window.clearInterval(g)}},500)}});document.getElementById("keyboard").disabled=true}var connection=new autobahn.Connection({url:"wss://89.109.64.175:8080/ws",realm:"realm1"});var t1,t2;var battery=0;var AngleChart=0;var chooseControl;connection.onopen=function(h,b){console.log("Connected");h.publish("general-topic",[probot_id]);var a="probot-topic-"+probot_id;var g="keepalive-"+probot_id;var d="probot-bat-"+probot_id;var i="probot-angle-"+probot_id;window.setInterval(function(){h.publish(g,[])},1000);function e(k){var l=k[0];var j;j=document.getElementById("battery");if(l=="error"){console.log("Stopped receiving battery");if(window.stopAlerts!=1){window.stopAlerts=1;alert("ProBot"+probot_id+" it is not responding. Please click OK and try again or choose another ProBot.");window.location=window.location}}else{if(l>=0&&l<=40){if(window.stopAlerts!=1){window.stopAlerts=1;alert("The Probot"+probot_id+" battery is too low. Please click OK and choose another ProBot.");window.location=window.location}}if(l>40&&l<=50){j.innerHTML="&#xf243;";j.style.color="red"}if(l>50&&l<=70){j.innerHTML="&#xf242;";j.style.color="orange"}if(l>70&&l<=100){j.innerHTML="&#xf240;";j.style.color="green"}}}function c(j){var k=j[0];console.log("ANGLE",k);AngleChart=parseFloat(k)+90;console.log("AngleChart na recepcao",AngleChart);f()}google.setOnLoadCallback(f);function f(){console.log("AngleChart no ciclo",AngleChart);var l=google.visualization.arrayToDataTable([["Label","Value"],["Degrees",AngleChart]]);var j={width:150,height:150,redFrom:70,redTo:110,redColor:"#00FF00",greenFrom:0,greenTo:180,greenColor:"#FF0000",minorTicks:20,max:180,min:0,majorTicks:["0","180"]};var k=new google.visualization.Gauge(document.getElementById("chart_div"));k.draw(l,j)}h.subscribe(d,e).then(function(j){console.log("subscribed to topic"+d)},function(j){console.log("failed to subscribe to topic",j)});h.subscribe(i,c).then(function(j){console.log("subscribed to topic"+i)},function(j){console.log("failed to subscribe to topic",j)});t1=setInterval(function(){keysMsg=[up.toFixed(3),down.toFixed(3),left.toFixed(3),right.toFixed(3)];h.publish(a,[keysMsg])},100);chooseControl=function(j){if(j=="keyboard"){keyboardHandler(h,a)}else{if(j=="joystick"){joystickHandler(h,a)}}}};connection.onclose=function(b,a){console.log("Connection lost: "+b);if(t1){clearInterval(t1);t1=null}if(t2){clearInterval(t2);t2=null}};connection.open();
