<!DOCTYPE html>
<html lang='en'>
	<head>
		<title>ProBot</title>
		<meta charset='utf-8'>
        	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        	<meta name="description" content="">
		<link rel="stylesheet" type="text/css" href="css/style_video_template.css">
        	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
		<meta name = 'viewport' content = 'width-device-width, initial-scale=1.0'>
		<link href='http://fonts.googleapis.com/css?family=Cabin' rel='stylesheet' type='text/css'>
        	<link rel="stylesheet" href="http://yoannmoinet.github.io/nipplejs/stylesheets/styles.css" media="screen" title="no title" charset="utf-8">
        	<link rel="stylesheet" href="http://yoannmoinet.github.io/nipplejs/stylesheets/github-light.css" media="screen" title="no title" charset="utf-8">
		<script src="jquery-1.11.2.js"></script>
		<script type="text/javascript" src="https://js.stripe.com/v2/"></script>

	<style>
        html, body {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 0;
            margin: 0;
        }

	#left {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 50%;
            background: rgba(0, 0, 0, 0);
        }
        
        #right {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 50%;
            background: rgba(0, 0, 0, 0);
        }
        
        #main{
            top: 10%;
            margin-left: 10%; 
            width:80%; 
            height:700px
        }

        </style>

      	</head>

	<!--<body onload="checkVariable()">-->


    	<div id="strip" >
        	<div class = "centerText">ProBot</div>
    	</div>

    	<div style=" top: 10%; margin-left: 10%; width:80%; height:600px" id = 'main' class='main' >
        	<iframe src="https://videolink2.me/probot1" frameborder="0" scrolling="yes"></iframe>    
    	</div>

    	<div style="top:70%;text-align: center; position:relative; width: 100%; border-width: 1px 0 0 0; ">
        	<p><h2>Choose the device that you want to control the ProBot. To change your choice, refresh the Webpage.</h2>.</p>
        	<button id="keyboard" onclick="keyboardHandler()">Keyboard</button>
        	<button id="joystick" onclick="joystickHandler()">Joystick</button>
    	</div>
	<div style="top:75%;text-align: center; position:relative; width: 100%; border-width: 1px 0 0 0; ">
		<input type="text" id="logId" />
	</div>

	<script type="text/javascript">

	var socket = null;
	var isopen = false;
	var up = 0;
	var down = 0;
	var left = 0;
	var right = 0;
	var keys = [];
	var res1=0;
	var positionLatitude=0;
	var positionLongitude=0;


	socket = new WebSocket("ws://89.109.64.175:9000");

	socket.onopen = function() {
  		console.log("Connected!");
  		isopen = true;
	}
        socket.onmessage = function (evt) 
           { 
           var received_msg = evt.data;
	   var res = received_msg.split(" ");
	   if (res[0]=="ProBot2_info"){
		res1= "Battery Voltage: " + res[1] + " V"; 
		}
	    if (res[0]=="GPSProBot2"){
		positionLatitude = res[1]; 
		positionLongitude = res[2]; 
		console.log(positionLatitude)
		console.log(positionLongitude)
		}

	   console.log(res);
	   document.getElementById("logId").value=res1;
	   
            };



	function keyboardHandler()
	{	
		document.onkeydown = checkKeyDown;
		function checkKeyDown(e)
		{
			e = e || window.event;
			
			keys[e.keyCode] = true;
		
			if(isopen)
			{
				if(keys[38] && keys[37])	//FRENTE E ESQUERDA
				{
					up = up + 0.080;
					if(up >= 0.750)
					{
						up = 0.750;
					}				
					left = left + 0.080;				
					if(left >= 0.750)
					{
						left = 0.750;
					}
					socket.send("web" + " " + up.toFixed(3) +" " + down.toFixed(3) + " " + left.toFixed(3) + " " + right.toFixed(3));
				}
				if(keys[38] && keys[39])	//FRENTE E DIREITA
				{
					up = up + 0.080;
					if(up >= 0.750)
					{
						up = 0.750;
					}	
					right = right + 0.080;				
					if(right >= 0.750)
					{
						right = 0.750;
					}
					socket.send("web" + " " + up.toFixed(3) +" " + down.toFixed(3) + " " + left.toFixed(3) + " " + right.toFixed(3));
				}
				if(keys[40] && keys[37])	//ATRAS E ESQUERDA
				{
					down = down + 0.080;
					if(down >= 0.750)
					{
						down = 0.750;
					}	
					left = left + 0.080;				
					if(left >= 0.750)
					{
						left = 0.750;
					}
					socket.send("web" + " " + up.toFixed(3) +" " + down.toFixed(3) + " " + left.toFixed(3) + " " + right.toFixed(3));
				}
				if(keys[40] && keys[39])	//ATRAS E DIREITA
				{
					down = down + 0.080;
					if(down >= 0.750)
					{
						down = 0.750;
					}	
					right = right + 0.080;				
					if(right >= 0.750)
					{
						right = 0.750;
					}
					socket.send("web" + " " + up.toFixed(3) +" " + down.toFixed(3) + " " + left.toFixed(3) + " " + right.toFixed(3));
				}
				if(e.keyCode == 38) //FRENTE
				{
					up = up + 0.080;
					if(up >= 0.750)
					{
						up = 0.750;
					}
					socket.send("web" + " " + up.toFixed(3) +" " + down.toFixed(3) + " " + left.toFixed(3) + " " + right.toFixed(3));
				}
				if(e.keyCode == 40) //TRAS
				{
					down = down + 0.080;
					if(down >= 0.750)
					{
						down = 0.750;
					}	
					socket.send("web" + " " + up.toFixed(3) +" " + down.toFixed(3) + " " + left.toFixed(3) + " " + right.toFixed(3));				
				}
				if(e.keyCode == 37) //ESQUERDA
				{
					left = left + 0.080;				
					if(left >= 0.750)
					{
						left = 0.750;
					}
					socket.send("web" + " " + up.toFixed(3) +" " + down.toFixed(3) + " " + left.toFixed(3) + " " + right.toFixed(3));
				}
				if(e.keyCode == 39) //DIREITA
				{
					right = right + 0.080;				
					if(right >= 0.750)
					{
						right = 0.750;
					}
					socket.send("web" + " " + up.toFixed(3) +" " + down.toFixed(3) + " " + left.toFixed(3) + " " + right.toFixed(3));
				}
			}		
		}

		document.onkeyup = checkKeyUp       
		function checkKeyUp(e)
		{			
			e = e || window.event;
			
			keys[e.keyCode] = false;
			
			if(isopen)
			{			
				if(!keys[38])	//FRENTE
				{
					up = 0;
					socket.send("web" + " " + up.toFixed(3) +" " + down.toFixed(3) + " " + left.toFixed(3) + " " + right.toFixed(3));
				}			
				if(!keys[40])	//TRAS
				{
					down = 0;
					socket.send("web" + " " + up.toFixed(3) +" " + down.toFixed(3) + " " + left.toFixed(3) + " " + right.toFixed(3));
				}
				if(!keys[37])	//ESQUERDA
				{
					left = 0;
					socket.send("web" + " " + up.toFixed(3) +" " + down.toFixed(3) + " " + left.toFixed(3) + " " + right.toFixed(3));
				}
				if(!keys[39])	//DIREITA
				{
					right = 0;
					socket.send("web" + " " + up.toFixed(3) +" " + down.toFixed(3) + " " + left.toFixed(3) + " " + right.toFixed(3));
				}			
			}
		}		
		document.getElementById("keyboard").disabled = true;
		document.getElementById("joystick").disabled = true;
	}


	function joystickHandler()
	{
    	var hasGP = false;
    	var repGP;
 
    	function canGame() 
		{
        	return "getGamepads" in navigator;
    	}
 
		function reportOnGamepad() 
		{
			var gp = navigator.getGamepads()[0];
			var html = "";
            html += "id: "+gp.id+"<br/>";
 
			for(var i=0;i<gp.buttons.length;i++)
			{
				html+= "Button "+(i+1)+": ";
				if(gp.buttons[i].pressed) html+= " pressed";
				html+= "<br/>";
			}
 
			for(var i=0;i<gp.axes.length; i+=2)
			{
				html+= "Stick "+(Math.ceil(i/2)+1)+": "+gp.axes[i]+","+gp.axes[i+1]+"<br/>";
            
				if (isopen) 
				{	
					if(gp.axes[1] == 0)
					{
						up = 0;
						down = 0;
					}
					if(gp.axes[1] < 0)	//UP
					{
						up = gp.axes[1] * -0.750;
						down = 0;
					}
					if(gp.axes[1] > 0)	//DOWN
					{
						down = gp.axes[1] * 0.750;
						up = 0;
					}				
				
					if(gp.axes[2] == 0)
					{
						left = 0;
						right = 0;
					}
					if(gp.axes[2] < 0)	//UP
					{
						left = gp.axes[2] * -0.750;
						right = 0;
					}
					if(gp.axes[2] > 0)	//DOWN
					{
						right = gp.axes[2] * 0.750;
						left = 0;
					}
					
					socket.send("web" + " " + up.toFixed(3) +" " + down.toFixed(3) + " " + left.toFixed(3) + " " + right.toFixed(3));
				}            
			}
			
			$("#gamepadDisplay").html(html);
    	}
 
    	$(document).ready(function() {
			if(canGame())
			{
				var prompt = "To begin using your gamepad, connect it and press any button!";
				$("#gamepadPrompt").text(prompt);
 
				$(window).on("gamepadconnected", function() {
					hasGP = true;
					$("#gamepadPrompt").html("Gamepad connected!");
					console.log("connection event");
					repGP = window.setInterval(reportOnGamepad,200);
				});
 
				$(window).on("gamepaddisconnected", function() {
					console.log("disconnection event");
					$("#gamepadPrompt").text(prompt);
					window.clearInterval(repGP);
				});
 
				//setup an interval for Chrome
				var checkGP = window.setInterval(function() {
					console.log('checkGP');
					if(navigator.getGamepads()[0])
					{
						if(!hasGP) $(window).trigger("gamepadconnected");
						window.clearInterval(checkGP);
					}
				}, 500);
			} 
    	});
		
    	document.getElementById("joystick").disabled = true;
    	document.getElementById("keyboard").disabled = true;
    }

    	</script>
    	
	</body>
</html>
